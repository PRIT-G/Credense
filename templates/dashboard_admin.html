<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Credense/title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <a href="/" class="logo">Cre<span>dense</span></a>
            <nav style="display: flex; align-items: center; gap: 1rem;">
                <span style="color: var(--text-gray); font-weight: 500;">Admin Dashboard</span>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-primary" style="padding: 8px 20px; font-size: 0.9rem;">Logout</a>
            </nav>
        </header>

        <section>
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <ul class="flashes" style="margin-bottom: 1.5rem;">
                {% set category, message = messages[-1] %}
                <li class="{{ category }}">{{ message }}</li>
            </ul>
            {% endif %}
            {% endwith %}

            <div class="auth-card" style="max-width: 100%; margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1.5rem; color: var(--primary);">Create New User</h3>
                <form action="{{ url_for('admin.create_user') }}" method="post"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; align-items: end;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Username</label>
                        <input type="text" name="username" class="form-control" required placeholder="New username">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Password</label>
                        <input type="text" name="password" class="form-control" required placeholder="User password">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Name</label>
                        <input type="text" name="name" class="form-control" placeholder="Full name">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Role</label>
                        <select name="role" class="form-control" required>
                            <option value="employee">Employee</option>
                            <option value="recruiter">Recruiter</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="height: 46px;">Create User</button>
                </form>
            </div>

            <div class="auth-card" style="max-width: 100%;">
                <h3 style="margin-bottom: 1.5rem; color: var(--text-white);">User Management</h3>

                <input type="text" id="searchInput" class="search-bar" placeholder="Search by name or username..."
                    onkeyup="filterTable()">

                <div class="tabs">
                    <button class="tab-btn active" onclick="openTab(event, 'employees')">Employees</button>
                    <button class="tab-btn" onclick="openTab(event, 'recruiters')">Recruiters</button>
                    <button class="tab-btn" onclick="openTab(event, 'admins')">Admins</button>
                    <button class="tab-btn" onclick="openTab(event, 'all')">All</button>
                </div>

                <!-- Employees Tab -->
                <div id="employees" class="tab-content active">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Password</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for username, data in users.items() if data.role == 'employee' %}
                            <tr>
                                <td>{{ username }}</td>
                                <td>{{ data.name }}</td>
                                <td><span class="badge badge-employee">EMPLOYEE</span></td>
                                <td style="font-family: monospace; opacity: 0.7;">{{ data.password }}</td>
                                <td>
                                    <button class="action-btn btn-update"
                                        onclick="openUpdateModal('{{ username }}', '{{ data.name }}')"><i class="fas fa-edit"></i> Edit</button>
                                    <a href="{{ url_for('admin.delete_user', username=username) }}"
                                        class="action-btn btn-delete"
                                        onclick="return confirm('Are you sure?')"><i class="fas fa-trash"></i> Delete</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Recruiters Tab -->
                <div id="recruiters" class="tab-content">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Password</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for username, data in users.items() if data.role == 'recruiter' %}
                            <tr>
                                <td>{{ username }}</td>
                                <td>{{ data.name }}</td>
                                <td><span class="badge badge-recruiter">RECRUITER</span></td>
                                <td style="font-family: monospace; opacity: 0.7;">{{ data.password }}</td>
                                <td>
                                    <button class="action-btn btn-update"
                                        onclick="openUpdateModal('{{ username }}', '{{ data.name }}')"><i class="fas fa-edit"></i> Edit</button>
                                    <a href="{{ url_for('admin.delete_user', username=username) }}"
                                        class="action-btn btn-delete"
                                        onclick="return confirm('Are you sure?')"><i class="fas fa-trash"></i> Delete</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Admins Tab -->
                <div id="admins" class="tab-content">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Password</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for username, data in users.items() if data.role == 'admin' %}
                            <tr>
                                <td>{{ username }}</td>
                                <td>{{ data.name }}</td>
                                <td><span class="badge badge-admin">ADMIN</span></td>
                                <td style="font-family: monospace; opacity: 0.7;">{{ data.password }}</td>
                                <td>
                                    <button class="action-btn btn-update"
                                        onclick="openUpdateModal('{{ username }}', '{{ data.name }}')"><i class="fas fa-edit"></i> Edit</button>
                                    {% if username != 'admin' %}
                                    <a href="{{ url_for('admin.delete_user', username=username) }}"
                                        class="action-btn btn-delete"
                                        onclick="return confirm('Are you sure?')"><i class="fas fa-trash"></i> Delete</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- All Tab -->
                <div id="all" class="tab-content">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Password</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for username, data in users.items() %}
                            <tr>
                                <td>{{ username }}</td>
                                <td>{{ data.name }}</td>
                                <td>
                                    <span class="badge badge-{{ data.role }}">
                                        {{ data.role|upper }}
                                    </span>
                                </td>
                                <td style="font-family: monospace; opacity: 0.7;">{{ data.password }}</td>
                                <td>
                                    <button class="action-btn btn-update"
                                        onclick="openUpdateModal('{{ username }}', '{{ data.name }}')"><i class="fas fa-edit"></i> Edit</button>
                                    {% if username != 'admin' %}
                                    <a href="{{ url_for('admin.delete_user', username=username) }}"
                                        class="action-btn btn-delete"
                                        onclick="return confirm('Are you sure?')"><i class="fas fa-trash"></i> Delete</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

            </div>
        </section>
    </div>

    <!-- Update User Modal -->
    <div id="updateModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 1.5rem; color: var(--text-white);">Edit User: <span id="modalUsernameDisplay" style="color: var(--primary);"></span></h3>
            <form action="{{ url_for('admin.update_user') }}" method="post">
                <input type="hidden" name="current_username" id="modalCurrentUsername">

                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="new_username" id="modalNewUsername" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>Name</label>
                    <input type="text" name="name" id="modalName" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>New Password (Leave blank to keep)</label>
                    <input type="text" name="new_password" class="form-control" placeholder="New Password">
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 1.5rem;">
                    <button type="button" class="btn" style="background: transparent; color: var(--text-gray);" onclick="closeUpdateModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update User</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].className = tabcontent[i].className.replace(" active", "");
            }
            tablinks = document.getElementsByClassName("tab-btn");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).className += " active";
            evt.currentTarget.className += " active";
        }

        function filterTable() {
            var input, filter, tabcontent, table, tr, td, i, j, txtValue;
            input = document.getElementById("searchInput");
            filter = input.value.toUpperCase();

            // Allow filtering across all visible tables (active tab)
            tabcontent = document.getElementsByClassName("tab-content active");
            if (tabcontent.length > 0) {
                table = tabcontent[0].getElementsByTagName("table")[0];
                tr = table.getElementsByTagName("tr");
                for (i = 1; i < tr.length; i++) {
                    tr[i].style.display = "none";
                    td = tr[i].getElementsByTagName("td");
                    for (j = 0; j < td.length; j++) {
                        if (td[j]) {
                            txtValue = td[j].textContent || td[j].innerText;
                            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                                tr[i].style.display = "";
                                break;
                            }
                        }
                    }
                }
            }
        }

        function openUpdateModal(username, name) {
            document.getElementById('updateModal').style.display = 'flex';
            document.getElementById('modalUsernameDisplay').innerText = username;
            document.getElementById('modalCurrentUsername').value = username;
            document.getElementById('modalNewUsername').value = username;
            document.getElementById('modalName').value = name;
        }
        function closeUpdateModal() {
            document.getElementById('updateModal').style.display = 'none';
        }
        window.onclick = function (event) {
            if (event.target == document.getElementById('updateModal')) {
                closeUpdateModal();
            }
        }
    </script>
</body>

</html>